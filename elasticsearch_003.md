# 4. 시스템 구조
## 4.1 클러스터와 노드 
엘라스틱서치의 가장 큰 시스템 단위인 클러스터는 하나 이상의 노드로 이루어져 있고, 노드는 각각 하나의 엘라스틱서치 프로세스로서 실행된다. config/elasticsearch.yml 파일에서 cluster.name을 설정한 이름이 같다면 다른 물리 서버와도 바인딩될 수 있다. 
### 4.1.1 노드 바인딩 
```
[시간~][transport ][노드명]bound_address{inet},publish_address {inet} //inet 정보로 실행된 포트와 ip를 알 수 있다.
[시간~][cluster.service ][노드명]new_master [노드명][~] // 해당 노드명이 마스터노드이다. 서브노드라면 detected_master[노드명] 로그가 출력되면서 마스터 노드를 탐지했다고 알려준다. 마스터노드의 로그를 확인해보면 join from node[노드명] 으로 출력되면서 조인된 서브노드를 알려준다.
[시간~][http ][노드명]bound_address~//http 로 연결된 ip와 포트를 확인할 수 있다.
```
이렇게 노드들이 바인딩되고 나면 입력과 출력 모두 어떤 포트로 연결해서 수행해도 같은 결과를 확인할 수 있다.
### 4.1.2 마스터 노드와 데이터 노드 
#### 마스터 노드 
전체 클러스터의 상태에 대한 메타 정보를 관리한다. config/elasticsearch.yml 에서 node.master=true 로 설정하면 마스터 노드가 될 자격을 얻는다.(선출될 자격이라고 한다.) 
#### 데이터 노드 
색인된 데이터를 실제로 저장하는 노드. node.data=false로 하면 데이터를 저장하지 않는다. 
단, 복제본이 저장될 공간이 없다면 복제본이 unassigned 상태가 된다.
마스터 노드와 데이터 노드가 반드시 상호 배타적인 관계는 아니다. 마스터 노드가 false이면서 데이터 노드로서도 false가 될 수 있다. ==보통 마스터 노드는 명령 수행을 전담으로 하는 창구 기능을 하고 데이터 노드는 http 통신 기능을 막아 놓고 REST API 접근을 차단하고 데이터를 저장하는 역할만을 전담하도록 설정하는 것이 일반적이다.==
## 4.2 샤드와 복사본(레플리카) 
샤드(shard)는 데이터 검색을 위해 구분되는 최소의 단위 인스턴스이다. 색인된 데이터는 여러 개의 샤드로 분할돼 저장된다. 기본적으로 인덱스당 5개의 샤드와 5개의 복사본으로 분리된다. 사용자는 인덱스 단위로 데이터를 처리하고 샤드는 엘라스틱서치가 직접 노드로 분산시키는 작업을 한다. 
처음 데이터가 색인돼 저장되는 공간을 최초 샤드(Primary shard)라고 한다. 최초 샤드에 데이터가 색인되고 나면 다시 동일한 최초 샤드 수만큼 복사본을 생성한다. 
### 복사본을 사용하는 이유 
1. 데이터 손실 방지. 최초 샤드와 복사본은 서로 다른 노드에 저장된다.
2. 성능 향상. 최초 샤드와 복사본을 동시에 검색해서 더 빠르게 데이터를 검색한다.
### 설정 
index.number_of_shards
index.number_of_replicas
>참조 : http://wiki.hash.kr/index.php/샤딩 
## 4.3 네트워크 바인딩과 디스커버리 
### 4.3.1 젠 디스커버리 
#### 멀티캐스트 방식 
기본적으로 활성화되어 있다. 접근가능한 모든 네트워크의 노드를 검색해서 같은 클러스터명의 노드를 찾아 바인딩한다. 
discovery.zen.ping.multicast.enabled
#### 유니캐스트 방식 
바인딩할 서버의 주소를 직접 지정한다. 이 방식의 사용을 권장한다. 
discovery.zen.ping.multicast.enabled=false //필수 
discovery.zen.ping.unicast.host: [~]
##### 유니캐스트 - 방화벽이 있는 경우
discovery.zen.ping.unicast.host: [내 내부 아이피, 다른 서버의 방화벽 외부 ip]
network.bind_host: 내 내부 아이피 
network.publish_host: 내 방화벽 외부 아이피



