
<<시작하세요! 엘라스틱서치>> -위키북스 김종민 지음 을 기반으로 공부한 내용을 요약
-----


# 1. 엘라스틱서치 
자바로 개발되어 아파치 탑레벨 프로젝트로 등록되어 있는 루씬의 강력한 검색 기능을 사용한 검색 솔루션이다. 엘라스틱 서치외에 티카(Tica), 솔라(Solr)등이 있다.
## 1.1 특징 
### 1. 아파치 루씬 기반
사용자 위치 정보(geolocation)을 사용 가능, 다국어 검색, 철자 수정 기능(Did you meman suggestion), 자동완성, 미리보기 등의 다양한 기능 지원 
### 2. 실시간 분석 
색인 작업이 완료됨과 동시에 바로 검색 가능 
> Q. 실시간 분석과 실시간 검색의 차이 
### 3. 분산 시스템 
여러 개의 노드로 구성되는 분산 시스템. 기존 노드에 새 노드를 실행해 연결하여 시스템 확장 용이. 데이터가 각 노드에 분산 저장되고 복사본을 유지하기 때문에 데이터 유실을 방지.
> 노드 : 엘라스틱서치의 단위 프로세스 
### 4. 높은 가용성 
하나 이상의 노드에 원본과 복사본을 나누어 저장하기 때문에 높은 가용성과 안전성 보장 
> Q. 가용성이란
### 5. 멀티 테넌시 
데이터는 여러 인덱스들에 그룹으로 저장된다. 인덱스는 RDB의 데이터베이스로 대응된다. 검색할 때 서로 다른 인덱스의 데이터를 하나의 질의로 묶어서 검색하고 출력할 수 있다.
> tenancy : 차용
> Q. 서로 다른 인덱스의 데이터를 하나의 질의로 묶어서 검색하는 예제가 무엇인지?
> Q. multi tenancy 의 의미와 뜻이 매칭이 안된다.
### 6. 전문검색 
전문검색(full text search)를 지원.
### 7. JSON 문서 기반 
### 8. RESTFul API WLDNJS 
## 1.2 데이터 색인 
### 용어 정리 
1. Indexing : 원본 문서를 검색할 수 있는 구조로 변경하여 저장하는 일련의 과정.
2. Index : indexing 과정을 거친 결과물 또는 결과물이 저장되는 데이터 공간 (=색인 공간, 색인)
3. 검색: 색인이 들어있는 토큰을 기준으로 해당하는 토큰이 포함되는 문서를 찾는 과정 
4. 질의(query)
> 원본 텍스트 - 인덱싱 - 색인 공간에 저장.
> 색인 공간에 질의(검색) <-> 결과 출력 
### 색인 구조 
#### RDB 의 경우 
|문서|문서 내용  |
|--|--|
|DOC1|blue sky green land red sun  |
|DOC2|blue ocean green land|
|DOC3|red flower|
#### 엘라스틱 서치의 경우 
역파일 색인 방식으로 데이터 저장
|검색어|검색어가 가리키는 문서|
|--|--|
|blue|DOC1, DOC2|
|sky|DOC1|
문서를 미리 색인해서 색인 공간에 표 1,2와 같은 파일 색인 데이터 구조를 만들어두고 색인 공간에서 문서를 출력한다.
> Q. 데이터를 저장하는 순간에 색인을 해서 검색어가 가리키는 문서를 업데이트하는 형식인가? 데이터가 너무 많아서 가리키는 문서가 많아진다면 어떻게 하지? 복사본을 저장할 때에는 원본을 가리킬까, 복사본을 가리킬까? 복사본은 어떤 형태로 저장이 되는거지?
### REST API 로 데이터 조회
```
http://localhost:9200/_cluster/state/nodes
```
로 노드들의 상태값을 조회
## 1.3 비교 
### 몽고DB와 엘라스틱 서치의 비교 
몽고DB는 데이터 저장소이고, 엘라스틱 서치는 검색 엔진이다. 
# 2. 엘라스틱서치 설치와 실행 
엘라스틱서치는 유닉스 운영체제를 기준으로 개발됐다. 
## 2.1 엘라스틱 서치 프로그램 구조
### bin/
실행파일, 플러그인 설치 파일, 실행 변수에 대한 설정 파일
-d 옵션으로 백그라운드로 실행 가능
### config/
설정파일, 로깅 설정 파일 
### lib/
사용 라이브러리들 
### data/
실제 색인된 문서의 검색 데이터가 저장되는 공간. 하위는 클러스터 명으로 생성된다. 
> Q. 색인 공간인가?
### logs/
로그 파일 저장
## 2.2 환경 설정 
1. **elasticsearch.in.sh, elasticsearch.yml 변경 **
2. 실행 시 -D, - - 옵션 사용 
3. REST API 사용 
### bin/elasticsearch.in.sh 
JVM 위에서 동작하는 실행 프로그램이니 만큼 메모리를 설정할 수 있다. elasticsearch.in.sh 에서 ES_MIN_MEM 이나 ES_MAX_MEM 옵션을 사용해서 사용할 최대, 최소 메모리를 설정할 수 있다. 또, ES_HEAP_SIZE를 설정해서 최대 최소 값을 통일시킬 수 있는데, 메모리 용량이 변경되는 불필요한 오버헤드를 방지하기 위해 권장된다.
>Q. 메모리 용량이 변경될 때 어떤 불필요한 오버헤드가 발생할까?
### config/elasticsearch.yml 
#### 클러스터 
**{설정 명}: {설정 값} // 콜론 뒤에 반드시 공백이 있어야 한다.**
클러스터 명 설정 
#### 노드 
실행된 하나의 엘라스틱서치 프로세스를 한 노드라고 하고 각 노드가 연결된 전체 시스템을 클러스터라고 한다. 
노드 명 설정 
#### 인덱스 
인덱스를 구성하는 샤드(Shard), 복사본(Replica) 설정. 보통 5개의 샤드와 1개의 복사본으로 이루어진다.
> Q. 샤드와 복사본의 의미
#### 경로 
각 경로들을 설정할 수 있다.
path.conf, path.data(여러 개 지정 가능), path.work(임시 작업 파일), path.logs, path.plugins
#### 플러그인 
플러그인 설치 가능. 
#### 메모리 
bootstrap.mlockall 설정을 사용해서 엘라스틱 서치가 사용하지 않는 메모리가 있을 때 jvm이 다른 자바 프로그램에 메모리를 할당하지 않도록 메모리를 고정할 수 있다. 이를 true로 설정하는 것을 추천한다. 
#### HTTP 네트워크 
같은 서버가 아닌, 다른 서버의 엘라스틱서치 노드와 연결 설정 
* transport.tcp.port, http.port 
* transport.tcp.compress : 통신하는 내용의 압축 여부 
* http.max_content_length : 전송하는 데이터의 용량 
* http.enabled : Rest API 통신 여부 
#### 게이트웨이 
엘라스틱서치의 전체 클러스터의 상태를 저장하는 저장소. 전체 클러스터가 종료된 후 재실행될 때 게이트웨이에 저장된 상태 값을 읽어들여 노드와 인덱스 등에 새로 설정하는데 이를 **리커버리**라 한다. 
* gateway.type 
* gateway.recover_after_nodes : 전체 클러스터가 재시작되고 몇 개의 노드가 활성화됐을 때 리커버리할지 
* gateway.recover_after_time : 전체 클러스터가 재시작되고 몇 개의 노드가 활성화되고 나서 얼마 동안의 시간을 기다린 후 리커버리할 지 
* gateway.exprected_nodes : 클러스터에 몇 개의 노드가 있는지 설정된 개수만큼 노드가 활성화 되면 즉시 리커버리 
#### 리커버리 제한 
리커버리란, 전체 클러스터가 재실행되거나 노드, 인덱스 등이 추가/삭제될 때 설정된 클러스터의 상태를 유지하기 위해 데이터를 복사하고 재배치하는 활동 
* cluster.routing.allocation.node_initial_primaries_recoveries
* cluster.routing.allocation.node_concurrent_recoveries
* indices.recovery.max_bytes_per_sec
* indeces.recovery.concurrent_streams
#### 디스커버리 
원격 네이트워크에 있는 노드와의 바인딩 설정 
#### 슬로우로그 
질의, 불러오기(fetch), 색인(indexing) 활동이 설정된 시간 이상이 소요됐을 때 debug 레벨의 로그로 기록한다. 
### config/logging.yml 
슬로우로그 파일의 저장 형식을 지정할 수 있다. 
## 플러그인 설치 
bin/plugin 프로그램을 사용해서설치한다. 
```
bin/plugin - - install {org}/{user/component}/{version}
```
플러그인의 설치 파일은 다음 위치 중 하나에 있어야 한다.
1. http://download.elasticsearch.org/ 에 있는 경로와 파일
2. http://search.maven.org/remotecontent?filepath= 에 있는 경로와 파일 
3. https://github.com 에 있는 경로와 파일 

